name: Laravel Auto Deploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy Laravel Application
        run: |
          echo "🚀 Starting MeetMyTech Auto Deployment..."
          cd /var/www/laravel
          echo "📥 Pulling latest code..."
          git fetch origin && git reset --hard origin/main
          echo "📦 Updating Composer dependencies..."
          composer install --no-dev --optimize-autoloader --no-interaction
          echo "🗄️ Running database migrations..."
          php artisan migrate --force
          echo "🧹 Clearing caches..."
          php artisan config:clear && php artisan route:clear && php artisan view:clear && php artisan cache:clear
          echo "⚡ Optimizing application..."
          php artisan config:cache && php artisan route:cache && php artisan view:cache
          echo "🔗 Linking storage..."
          php artisan storage:link
          echo "🔧 Setting file permissions..."
          sudo chown -R www-data:www-data /var/www/laravel
          sudo chmod -R 755 /var/www/laravel/storage /var/www/laravel/bootstrap/cache /var/www/laravel/public
          echo "🔄 Restarting services..."
          sudo systemctl restart apache2
          sudo systemctl restart php8.2-fpm || sudo systemctl restart php8.1-fpm || true
          echo "🔐 Verifying SSL configuration..."
          sudo apache2ctl configtest
          echo "🌐 Testing subdomain SSL..."
          curl -I https://vikas.meetmytech.com/ || echo "SSL test completed"
          echo "✅ Deployment completed successfully!"
